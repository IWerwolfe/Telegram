# Телеграм бот для техподдержки

## Описание

Бот создавался как дополнение к CRM 1С, который бы решал часть бизнес задач, в процессе развития выделен в самостоятельный сервис со своим API и базой данных, который может взаимодействовать с любой внешней CRM системой.     
Необходимость в нем возникла, когда возросло количество обращений в техподдержку и начали возникать проблемы с потерянными заказами, менеджеры не успевали все заносить, клиенты недовольны сроками, мастера могли закрывать обращения толком их, не выполнив.

Часть проблем решает данный бот, он дает возможность контрагенту:
  - оставить обращение в техподдержку в любое время суток
  - посмотреть активные обращения и статус их выполнения
  - отменить, отредактировать обращение через бот, что повышает контроль для компаний с большим количеством филиалов
  - оплатить, пополнить баланс, что экономит время
  - получать уведомления о новых обращениях в вашей организации, изменении статуса обращений
  - повысить прозрачность: видно кто из мастеров занимается обращением, кто из работников обратился, позволяет выявить наиболее частые проблемы
  - не нужно объяснять детали (модель кассы, адрес, название компании и т.д.) все есть базе данных
    
Для техподдержки дает возможность:
  - фиксировать обращения, в том числе и не рабочее время
  - позволяет снизить нагрузку на менеджеров
  - снижать количество потерянных обращений, чем улучшает качество сервиса и повышает прибыль
  - снижать дублирование обращений, когда одно обращение заносится несколько раз
  - повысить прозрачность для администраторов, видно кто что делал и сколько времени
  - автоматизировать создание карточек при первом обращении, теперь не нужно заносить реквизиты контрагента вручную
  - настроить отправку уведомлений в общую рабочую группу

Для 1С написано расширение конфигурации для УНФ 1.6.50, которое позволяет взаимодействовать с ботом и обращениями клиентов: 
  - удобная форма для взаимодействия
  - возможность управления обращениями
  - отчеты, статистика по компаниям, мастерам, видам обращений
  - система оценки эффективности мастеров
  - API сервисы для взаимодействия с сайтом, телеграм ботами через HTTP
  - автоматическое выставление и отправка счетов на оплату по итогам месяца

## Рабочая версия

https://t.me/KassaKomTestBot
Запущен для демонстрации возможностей и для тестирования. Можно выполнять все операции, они ни к чему не обязывают, ваши личные данные не сохраняются.    
Оплата подключена через тестовый контур.

## Схема работы

Реализовано 2 схемы работы: с регистрацией и без. После регистрации упрощается подача обращений, больше не потребуется каждый раз вводить номер телефона для связи и имя.     
При нажатии на кнопку "Зарегистрироваться" ваш номер телефона отправляется в 1С и там проверяется, если номер телефона указан как контактный, в бот отправляется вся информация по контрагенту, и, в зависимости от роли (USER, ADMINISTRATOR, DIRECTOR), которая определяется автоматически, появляется доступ к информации и возможностям бота. 

Деление по ролям

Для UNAUTHORIZED: (автоматически при первом использовании бота)
  - Создавать обращения
  - Пополнять баланс
  - Проверять баланс
  - Редактировать свои обращения
  - Закрывать свои обращения

Для USER: (если номер телефона указан у контактных лиц контрагента)
  - Все возможности для UNAUTHORIZED
  - Отправлять обращения от имени контрагента
  - Получать уведомления о новых обращениях от контрагента (зависит от настроек)

Для ADMINISTRATOR:  (если номер телефона указан как контактный для контрагента, либо бухгалтера, администратора)
  - Все возможности для UNAUTHORIZED, USER
  - Доступ ко всем активным обращениям от контрагента
  - Редактирование и закрытие чужих обращений от контрагента
  - Доступ к балансу контрагента
  - Возможность пополнять баланс от имени контрагента

Для DIRECTOR:  (если номер телефона указан как контактный для директора, ИП)
  - Полный доступ ко всем функциям

Если по номеру телефона ничего не найдено, тогда потребуется заполнить небольшую анкету. Бот спросит ваше ФИО, ИНН организации и вашу должность, после чего будет произведен запрос данных по ИНН, создание нового контрагента и синхронизация данных с 1С. В этом случае всегда присваивается роль USER.     
       
Реализован двухсторонний обмен данными с 1С, все что создается и редактируется в телеграм боте, автоматически отправляется в 1С и соответственно все что создается и редактируется в 1С, отправляется в телеграм бот. При ошибках обмена данные фиксируются, в планах реализовать регламентное задание, которое автоматически производила обмен данными в этом случае.      

Данные контрагента представлены в следующем виде:    
  - Контрагент    
    - Торговая точка    
        - Контактное лицо       
      
Обращения можно оставлять с привязкой к Торговой точке так и без привязки.    
Предусмотрена ситуация когда у одного человека несколько организаций, в данном случае бот предложит выбрать из списка, аналогично происходит когда у организации несколько торговых точек.

## Описание файла настроек

В application-production.yml находятся конфигурируемые параметры нашего приложения:   

```
#profile name production
server.port=8181 - порт приложения
spring.main.banner-mode=off - отключить баннер SRING при запуске

# Настройка логгирования
logging.level=DEBUG
logging.level.org.springframework.web=DEBUG
logging.level.org.hibernate=ERROR
logging.file.name=LOGS/prod_app.log - путь к файлу
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# Данные бота 
bot.name=[ имя бота ]
bot.token=[ токен (можно получить через @BotFather) ]
bot.payment=[ платежный токен (можно получить через @BotFather) ]

# Настройки базы данных
spring.datasource.url=jdbc:sqlserver:[ путь к базе данных ]
spring.datasource.username=[ имя пользователя ]
spring.datasource.password=[ пароль ]
spring.datasource.driverClassName=com.microsoft.sqlserver.jdbc.SQLServerDriver - драйвер, зависит от типа БД
spring.jpa.show-sql=false - отражать в логах SQL запросы
spring.jpa.hibernate.dialect=org.hibernate.dialect.SQLServer2012Dialect - диалект, зависит от типа БД
spring.jpa.hibernate.ddl-auto=update

# Настройка сервиса DaData (для получения данных по ИНН)
dadata.api.key=[ токен ]

# Настройки для доступа к 1С
Connector1C.url=[ путь к API ]
Connector1C.token=[ Токен, UiD конфигурации ]
Connector1C.login=[ Имя пользователя БД 1С ]
Connector1C.password= [ Пароль от БД 1С ]

# Настройки оплат
pay.sbpStatic=[ ссылка для оплаты через СПБ  ]
pay.isUse=true - включить возможность оплаты через бот 
pay.isBalanceVisibly=true - отображать баланс
pay.isAddBalance=false - разрешить пополнение баланса
pay.isCard=true - включить оплату банковской картой
pay.isBank=false - включить выставление счетов на оплату (не реализовано)
pay.isSBPStatic=true - включить возможность оплаты через СПБ
pay.isSBP=false - включить оплату через СПБ API (не реализовано)
pay.isCrypto=false - включить оплату криптовалютой (не реализовано)

# Настройка общих уведомлений
system.isUse=true - включить отправку уведомлений
system.idToWorkGroup=[ телеграм id рабочей группы для отправки уведомлений ]
system.isSendCreateNewTask=true - уведомлять о новом обращении
system.isSendEditTask=false - уведомлять о редактировании обращения 
system.isClosedTask=false - уведомлять о закрытии обращения 
system.isUserClosedTask=true - уведомлять о закрытии обращения клиентом

# Настройка уведомлений, отправляемых клиенту
user.isUse=true - включить отправку уведомлений 
user.isSendCreateNewTask=true - уведомлять о новом обращении
user.isSendEditTask=false - уведомлять о редактировании обращения
user.isClosedTask=true - уведомлять о закрытии обращения
user.balanceIsReplenished=false - требуется пополнить баланс  
user.needToPayTask=false - требуется оплатить обращение
user.taskIsPaid=false - поступила плата за обращение (отправляется только при оплате в офисе либо по счету)

# Настройка уведомлений при ошибках
bug.isUse=true - включить отправку уведомлений 
bug.idTelegramUser=[ телеграм id пользователя для отправки уведомлений ]
```

## Разработка

В данном проекте все реализовано мной, в том числе и код для 1С.   

Язык: Java 17      
Использовалось: Spring boot, Spring Framework, Lombok, MSSQL, API REST, JUnit, Mockito, API telegram, 1C    
Система сборки проектов: maven     
